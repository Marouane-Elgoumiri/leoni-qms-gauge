<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Predictions - LEONI Technician Dashboard</title>
    <link rel="icon" href="../assets/logo.png?v=2025" type="image/png">
    <link rel="shortcut icon" href="../assets/logo.png?v=2025" type="image/png">
    <link rel="apple-touch-icon" href="../assets/logo.png?v=2025">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="technician-analytics.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="header">
            <div class="header-logo">
                <img src="../assets/logo.png" alt="LEONI Logo">
                <div>
                    <h2>LEONI</h2>
                    <p style="font-size: 0.8rem; color: #6b7280;">Quality Excellence</p>
                </div>
            </div>
            
            <div class="header-title">
                <h1><i class="fas fa-chart-line"></i> Quality Predictions</h1>
                <p class="header-subtitle">Smart Quality Forecasting for Production Lines</p>
            </div>
            
            <div class="ai-status">
                <div class="pulse"></div>
                <span>System Ready</span>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="kpi-overview">
                <h3 style="color: #374151; margin-bottom: 1rem;">Live KPIs</h3>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Overall Efficiency</span>
                        <i class="fas fa-chart-line" style="color: var(--primary-color);"></i>
                    </div>
                    <div class="kpi-value">94.2%</div>
                    <div class="kpi-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>+2.3%</span>
                    </div>
                </div>

                <div class="kpi-card" style="border-left-color: var(--success-color);">
                    <div class="kpi-header">
                        <span class="kpi-title">Quality Score</span>
                        <i class="fas fa-star" style="color: var(--success-color);"></i>
                    </div>
                    <div class="kpi-value" style="color: var(--success-color);">98.7%</div>
                    <div class="kpi-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>+0.8%</span>
                    </div>
                </div>

                <div class="kpi-card" style="border-left-color: var(--warning-color);">
                    <div class="kpi-header">
                        <span class="kpi-title">Production Rate</span>
                        <i class="fas fa-tachometer-alt" style="color: var(--warning-color);"></i>
                    </div>
                    <div class="kpi-value" style="color: var(--warning-color);">87.5%</div>
                    <div class="kpi-trend trend-down">
                        <i class="fas fa-arrow-down"></i>
                        <span>-1.2%</span>
                    </div>
                </div>
            </div>

            <div style="background: #f8fafc; border-radius: var(--border-radius); padding: 1rem;">
                <h4 style="color: #374151; margin-bottom: 0.5rem;">Quick Tasks</h4>
                <div style="display: grid; gap: 0.5rem;">
                    <button class="ml-button" style="font-size: 0.875rem; padding: 0.5rem;">
                        <i class="fas fa-calculator"></i>
                        Check Quality
                    </button>
                    <button class="ml-button" style="font-size: 0.875rem; padding: 0.5rem;">
                        <i class="fas fa-file-alt"></i>
                        View Report
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Simple Quality Check Controls -->
            <section class="ml-controls">
                <div class="ml-controls-title">
                    <i class="fas fa-search"></i>
                    Quality Check Settings
                </div>
                
                <div class="ml-controls-grid">
                    <div class="control-group">
                        <label class="control-label">Production Line</label>
                        <select class="control-select" id="productionLine">
                            <option value="hdep-c1">HDEP C1</option>
                            <option value="hdep-c2">HDEP C2</option>
                            <option value="vce">VCE Line</option>
                            <option value="mdep">MDEP</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Check Period</label>
                        <select class="control-select" id="timePeriod">
                            <option value="1h">Next Hour</option>
                            <option value="8h">Next Shift</option>
                            <option value="24h">Next Day</option>
                            <option value="7d">Next Week</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Alert Level</label>
                        <select class="control-select" id="alertLevel">
                            <option value="high">High Alerts Only</option>
                            <option value="medium">Medium & High</option>
                            <option value="all">All Alerts</option>
                        </select>
                    </div>
                </div>

                <div class="ml-actions">
                    <button class="ml-button" onclick="runQualityCheck()">
                        <i class="fas fa-play"></i>
                        Check Quality
                    </button>
                    <button class="ml-button" onclick="exportResults()" style="background: var(--gradient-success);">
                        <i class="fas fa-download"></i>
                        Save Report
                    </button>
                </div>
            </section>

            <!-- TRAM Metrics Container -->
            <section class="tram-metrics-container">
                <div class="metrics-header">
                    <h2 class="metrics-title">Current Quality Status</h2>
                    <div class="metrics-controls">
                        <button class="metric-filter active" data-filter="all">All Metrics</button>
                        <button class="metric-filter" data-filter="quality">Quality</button>
                        <button class="metric-filter" data-filter="efficiency">Efficiency</button>
                    </div>
                    <div class="ml-status-indicator">
                        <div class="pulse"></div>
                        <span>Live Data</span>
                    </div>
                </div>

                <!-- Enhanced TRAM Analytics -->
                <section class="tram-analytics">
                    <div class="tram-card rft">
                        <div class="tram-header">
                            <div>
                                <div class="tram-value" id="rftValue">
                                    96.8<span class="tram-unit">%</span>
                                </div>
                                <div class="tram-label">First Time Right</div>
                            </div>
                            <div class="tram-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="tram-chart">
                            <div class="chart-line" style="--chart-width: 87%; background: var(--success-color);"></div>
                        </div>
                        <div class="tram-details">
                            <div class="detail-item">
                                <span>Goal:</span>
                                <span class="detail-value">95.0%</span>
                            </div>
                            <div class="detail-item">
                                <span>Trend:</span>
                                <span class="detail-value" style="color: var(--success-color);">â†— Better</span>
                            </div>
                        </div>
                    </div>

                    <div class="tram-card ppm">
                        <div class="tram-header">
                            <div>
                                <div class="tram-value" id="ppmValue">
                                    142<span class="tram-unit">PPM</span>
                                </div>
                                <div class="tram-label">Defects Per Million</div>
                            </div>
                            <div class="tram-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="tram-chart">
                            <div class="chart-line" style="--chart-width: 65%; background: var(--warning-color);"></div>
                        </div>
                        <div class="tram-details">
                            <div class="detail-item">
                                <span>Limit:</span>
                                <span class="detail-value">< 200</span>
                            </div>
                            <div class="detail-item">
                                <span>Trend:</span>
                                <span class="detail-value" style="color: var(--success-color);">â†˜ Better</span>
                            </div>
                        </div>
                    </div>

                    <div class="tram-card scrap">
                        <div class="tram-header">
                            <div>
                                <div class="tram-value" id="scrapValue">
                                    2.3<span class="tram-unit">kg</span>
                                </div>
                                <div class="tram-label">Waste Material</div>
                            </div>
                            <div class="tram-icon">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                        <div class="tram-chart">
                            <div class="chart-line" style="--chart-width: 45%; background: var(--danger-color);"></div>
                        </div>
                        <div class="tram-details">
                            <div class="detail-item">
                                <span>Limit:</span>
                                <span class="detail-value">< 3.0kg</span>
                            </div>
                            <div class="detail-item">
                                <span>Trend:</span>
                                <span class="detail-value" style="color: var(--success-color);">â†˜ Better</span>
                            </div>
                        </div>
                    </div>

                    <div class="tram-card efficiency">
                        <div class="tram-header">
                            <div>
                                <div class="tram-value" id="efficiencyValue">
                                    89.2<span class="tram-unit">%</span>
                                </div>
                                <div class="tram-label">Production Efficiency</div>
                            </div>
                            <div class="tram-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                        </div>
                        <div class="tram-chart">
                            <div class="chart-line" style="--chart-width: 78%; background: var(--info-color);"></div>
                        </div>
                        <div class="tram-details">
                            <div class="detail-item">
                                <span>Goal:</span>
                                <span class="detail-value">85.0%</span>
                            </div>
                            <div class="detail-item">
                                <span>Trend:</span>
                                <span class="detail-value" style="color: var(--success-color);">â†— Better</span>
                            </div>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Quality Predictions -->
            <section class="ml-results">
                <div class="results-section predictions">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h3 class="section-title">What to Expect Next</h3>
                    </div>
                    
                    <div class="prediction-grid" id="predictionsGrid">
                        <div class="prediction-item high-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">Next Hour Quality</span>
                                <span class="confidence-badge confidence-high">Very Likely</span>
                            </div>
                            <div class="prediction-value">97.2%</div>
                            <div style="font-size: 0.75rem; color: #059669; margin-top: 0.5rem;">
                                âœ“ Quality will stay excellent
                            </div>
                        </div>

                        <div class="prediction-item medium-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">Expected Defects</span>
                                <span class="confidence-badge confidence-medium">Likely</span>
                            </div>
                            <div class="prediction-value">156 PPM</div>
                            <div style="font-size: 0.75rem; color: #d97706; margin-top: 0.5rem;">
                                âš  Monitor closely
                            </div>
                        </div>

                        <div class="prediction-item high-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">Waste Forecast</span>
                                <span class="confidence-badge confidence-high">Very Likely</span>
                            </div>
                            <div class="prediction-value">1.8kg</div>
                            <div style="font-size: 0.75rem; color: #059669; margin-top: 0.5rem;">
                                âœ“ Within acceptable limits
                            </div>
                        </div>
                    </div>
                </div>

                <div class="results-section classification">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <h3 class="section-title">Quality Assessment</h3>
                    </div>
                    
                    <div class="prediction-grid" id="classificationGrid">
                        <div class="prediction-item high-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">Overall Status</span>
                                <span class="confidence-badge confidence-high">Confirmed</span>
                            </div>
                            <div class="prediction-value" style="font-size: 1.2rem; color: #059669;">Excellent</div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                                All metrics on target
                            </div>
                        </div>

                        <div class="prediction-item medium-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">Risk Level</span>
                                <span class="confidence-badge confidence-medium">Likely</span>
                            </div>
                            <div class="prediction-value" style="font-size: 1.2rem; color: #059669;">Low Risk</div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                                No immediate action needed
                            </div>
                        </div>

                        <div class="prediction-item high-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">Maintenance Need</span>
                                <span class="confidence-badge confidence-high">Confirmed</span>
                            </div>
                            <div class="prediction-value" style="font-size: 1.2rem; color: #059669;">Not Required</div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                                Equipment running well
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Recommendations -->
                <div class="results-section recommendations" style="margin-top: 2rem;">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <h3 class="section-title">Recommended Actions</h3>
                    </div>
                    
                    <div class="recommendations-list" id="recommendationsList">
                        <div class="recommendation-item priority-low">
                            <div class="recommendation-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="recommendation-content">
                                <div class="recommendation-title">Continue Current Process</div>
                                <div class="recommendation-description">Quality metrics are excellent. Maintain current operating procedures.</div>
                            </div>
                        </div>

                        <div class="recommendation-item priority-medium">
                            <div class="recommendation-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="recommendation-content">
                                <div class="recommendation-title">Monitor PPM Levels</div>
                                <div class="recommendation-description">Keep watching defect rates. Alert supervisor if it goes above 180 PPM.</div>
                            </div>
                        </div>

                        <div class="recommendation-item priority-low">
                            <div class="recommendation-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="recommendation-content">
                                <div class="recommendation-title">Document Best Practices</div>
                                <div class="recommendation-description">Current efficiency is high. Record what's working well for future reference.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-nav">
                <a href="../Agents_onBoarding/technician-onboarding.html" class="footer-link">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <a href="../index.html" class="footer-link">
                    <i class="fas fa-home"></i> Main Menu
                </a>
            </div>
            
            <div style="color: #6b7280; font-size: 0.875rem;">
                <i class="fas fa-shield-alt"></i> Quality System v2.1 | Last Updated: July 2025
            </div>
        </footer>
    </div>

    <!-- Chatbot Interface -->
    <button class="chat-button" id="chatButton">
        ðŸ’¬
    </button>

    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <h3><i class="fas fa-headset"></i> Quality Assistant</h3>
            <p>Get help with quality questions and procedures</p>
            <button class="chat-close" id="chatClose">Ã—</button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div style="color: #6b7280; font-style: italic; text-align: center; padding: 2rem;">
                Ask me about quality standards, procedures, troubleshooting, or what these numbers mean...
            </div>
        </div>
        
        <div class="chat-suggestions" id="chatSuggestions">
            <!-- Suggestions will be loaded here -->
        </div>
        
        <div class="chat-input-container">
            <div class="chat-input-group">
                <input type="text" class="chat-input" placeholder="Ask about quality standards, procedures, or numbers..." id="chatInput">
                <button class="chat-send" id="chatSend">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <div class="chat-resize-handle" id="chatResizeHandle"></div>
    </div>

    <script>
        // Simple Quality Check Engine
        class QualityCheckEngine {
            constructor() {
                this.isRunning = false;
                this.historicalData = this.generateHistoricalData();
                this.alertThresholds = {
                    rft: 95.0,
                    ppm: 200,
                    scrap: 3.0,
                    efficiency: 85.0
                };
            }

            generateHistoricalData() {
                const data = [];
                for (let i = 0; i < 100; i++) {
                    data.push({
                        timestamp: new Date(Date.now() - i * 3600000),
                        rft: 95 + Math.random() * 4,
                        ppm: 120 + Math.random() * 80,
                        scrap: 1.5 + Math.random() * 2,
                        efficiency: 85 + Math.random() * 10
                    });
                }
                return data;
            }

            async runQualityCheck(period) {
                // Simulate quality check processing
                await this.simulateProcessing(1500);
                
                const recent = this.historicalData.slice(0, period === '1h' ? 1 : period === '8h' ? 8 : 24);
                
                const predictions = {
                    rft: this.predictMetric(recent, 'rft'),
                    ppm: this.predictMetric(recent, 'ppm'),
                    scrap: this.predictMetric(recent, 'scrap'),
                    efficiency: this.predictMetric(recent, 'efficiency')
                };

                const assessment = this.assessQuality(predictions);
                const recommendations = this.generateRecommendations(predictions, assessment);

                return { predictions, assessment, recommendations };
            }

            predictMetric(data, metric) {
                const average = data.reduce((sum, item) => sum + item[metric], 0) / data.length;
                const variation = (Math.random() - 0.5) * 0.05;
                const trend = Math.sin(Date.now() / 1000000) * 0.03;
                
                let prediction = average + (average * variation) + (average * trend);
                
                // Ensure realistic bounds
                switch(metric) {
                    case 'rft':
                        prediction = Math.max(90, Math.min(99, prediction));
                        break;
                    case 'ppm':
                        prediction = Math.max(50, Math.min(300, prediction));
                        break;
                    case 'scrap':
                        prediction = Math.max(0.5, Math.min(5, prediction));
                        break;
                    case 'efficiency':
                        prediction = Math.max(75, Math.min(95, prediction));
                        break;
                }
                
                return {
                    value: prediction,
                    confidence: this.calculateConfidence(prediction, metric),
                    status: this.getStatus(prediction, metric)
                };
            }

            calculateConfidence(value, metric) {
                const threshold = this.alertThresholds[metric];
                let confidence = 0.8;
                
                // Higher confidence when values are clearly good or bad
                switch(metric) {
                    case 'rft':
                        confidence = value > threshold ? 0.9 + Math.random() * 0.08 : 0.75 + Math.random() * 0.1;
                        break;
                    case 'ppm':
                        confidence = value < threshold ? 0.9 + Math.random() * 0.08 : 0.75 + Math.random() * 0.1;
                        break;
                    case 'scrap':
                        confidence = value < threshold ? 0.9 + Math.random() * 0.08 : 0.75 + Math.random() * 0.1;
                        break;
                    case 'efficiency':
                        confidence = value > threshold ? 0.9 + Math.random() * 0.08 : 0.75 + Math.random() * 0.1;
                        break;
                }
                
                return Math.min(0.98, confidence);
            }

            getStatus(value, metric) {
                const threshold = this.alertThresholds[metric];
                
                switch(metric) {
                    case 'rft':
                        return value >= threshold ? 'good' : 'warning';
                    case 'ppm':
                        return value <= threshold ? 'good' : 'warning';
                    case 'scrap':
                        return value <= threshold ? 'good' : 'warning';
                    case 'efficiency':
                        return value >= threshold ? 'good' : 'warning';
                    default:
                        return 'unknown';
                }
            }

            assessQuality(predictions) {
                const goodCount = Object.values(predictions).filter(p => p.status === 'good').length;
                const totalCount = Object.keys(predictions).length;
                
                if (goodCount === totalCount) {
                    return { overall: 'excellent', risk: 'low', maintenance: 'not-required' };
                } else if (goodCount >= totalCount * 0.75) {
                    return { overall: 'good', risk: 'low', maintenance: 'not-required' };
                } else if (goodCount >= totalCount * 0.5) {
                    return { overall: 'acceptable', risk: 'medium', maintenance: 'consider' };
                } else {
                    return { overall: 'poor', risk: 'high', maintenance: 'required' };
                }
            }

            generateRecommendations(predictions, assessment) {
                const recommendations = [];
                
                if (assessment.overall === 'excellent') {
                    recommendations.push({
                        priority: 'low',
                        title: 'Continue Current Process',
                        description: 'Quality metrics are excellent. Maintain current operating procedures.',
                        icon: 'info-circle'
                    });
                }
                
                if (predictions.ppm.value > 150) {
                    recommendations.push({
                        priority: 'medium',
                        title: 'Monitor PPM Levels',
                        description: 'Keep watching defect rates. Alert supervisor if it goes above 180 PPM.',
                        icon: 'eye'
                    });
                }
                
                if (predictions.efficiency.value > this.alertThresholds.efficiency + 2) {
                    recommendations.push({
                        priority: 'low',
                        title: 'Document Best Practices',
                        description: 'Current efficiency is high. Record what\'s working well for future reference.',
                        icon: 'chart-line'
                    });
                }
                
                if (predictions.scrap.value > this.alertThresholds.scrap * 0.8) {
                    recommendations.push({
                        priority: 'medium',
                        title: 'Check Material Waste',
                        description: 'Waste levels are increasing. Review cutting and handling procedures.',
                        icon: 'recycle'
                    });
                }
                
                return recommendations;
            }

            async simulateProcessing(duration) {
                return new Promise(resolve => setTimeout(resolve, duration));
            }
        }

        // Initialize Quality Check Engine
        const qualityEngine = new QualityCheckEngine();

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            initializeMetricFilters();
            startRealTimeUpdates();
            startAdvancedAnimations();
        });

        function initializeDashboard() {
            // Add fade-in animation to cards
            const cards = document.querySelectorAll('.tram-card, .prediction-item, .insight-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in');
                }, index * 100);
            });
        }

        function initializeMetricFilters() {
            const filterBtns = document.querySelectorAll('.metric-filter');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterMetrics(this.dataset.filter);
                });
            });
        }

        function filterMetrics(filter) {
            const cards = document.querySelectorAll('.tram-card');
            cards.forEach(card => {
                if (filter === 'all') {
                    card.style.display = 'grid';
                } else if (filter === 'quality') {
                    card.style.display = card.classList.contains('rft') || card.classList.contains('ppm') ? 'grid' : 'none';
                } else if (filter === 'efficiency') {
                    card.style.display = card.classList.contains('efficiency') || card.classList.contains('scrap') ? 'grid' : 'none';
                }
            });
        }

        async function runQualityCheck() {
            if (qualityEngine.isRunning) return;
            
            qualityEngine.isRunning = true;
            const button = document.querySelector('.ml-button');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking Quality...';
            button.disabled = true;
            
            // Add loading animation to results
            const resultsSections = document.querySelectorAll('.results-section');
            resultsSections.forEach(section => section.classList.add('loading'));
            
            try {
                const timePeriod = document.getElementById('timePeriod').value;
                const period = timePeriod === '1h' ? 1 : timePeriod === '8h' ? 8 : 24;
                
                // Run quality check
                const results = await qualityEngine.runQualityCheck(period);
                
                // Update UI with results
                await updatePredictionsSimple(results.predictions, timePeriod);
                await updateAssessmentSimple(results.assessment);
                await updateRecommendationsSimple(results.recommendations);
                await updateTRAMValuesAdvanced();
                
                // Update chart animations
                updateChartVisuals();
                
                showNotification('Quality check completed successfully!', 'success');
            } catch (error) {
                showNotification('Quality check failed: ' + error.message, 'error');
            } finally {
                // Remove loading state
                resultsSections.forEach(section => section.classList.remove('loading'));
                button.innerHTML = originalText;
                button.disabled = false;
                qualityEngine.isRunning = false;
            }
        }

        async function updatePredictionsSimple(predictions, timePeriod) {
            const periodLabels = {
                '1h': 'Next Hour',
                '8h': 'Next Shift', 
                '24h': 'Next Day',
                '7d': 'Next Week'
            };
            
            const metrics = [
                { key: 'rft', label: `${periodLabels[timePeriod]} Quality`, unit: '%' },
                { key: 'ppm', label: 'Expected Defects', unit: ' PPM' },
                { key: 'scrap', label: 'Waste Forecast', unit: 'kg' }
            ];
            
            const grid = document.getElementById('predictionsGrid');
            
            grid.innerHTML = metrics.map(metric => {
                const pred = predictions[metric.key];
                const confidence = Math.floor(pred.confidence * 100);
                const confidenceClass = confidence > 90 ? 'high' : confidence > 75 ? 'medium' : 'low';
                const confidenceLabel = confidence > 90 ? 'Very Likely' : confidence > 75 ? 'Likely' : 'Possible';
                const statusIcon = pred.status === 'good' ? 'âœ“' : 'âš ';
                const statusColor = pred.status === 'good' ? '#059669' : '#d97706';
                const statusText = pred.status === 'good' ? 
                    (metric.key === 'rft' ? 'Quality will stay excellent' : 
                     metric.key === 'ppm' ? 'Within acceptable limits' : 'Within acceptable limits') :
                    (metric.key === 'rft' ? 'Quality may decline' :
                     metric.key === 'ppm' ? 'Monitor closely' : 'Monitor closely');
                
                return `
                    <div class="prediction-item ${confidenceClass}-confidence fade-in">
                        <div class="prediction-header">
                            <span class="prediction-metric">${metric.label}</span>
                            <span class="confidence-badge confidence-${confidenceClass}">
                                ${confidenceLabel}
                            </span>
                        </div>
                        <div class="prediction-value">${formatPredictionValueSimple(pred.value, metric.key)}</div>
                        <div style="font-size: 0.75rem; color: ${statusColor}; margin-top: 0.5rem;">
                            ${statusIcon} ${statusText}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatPredictionValueSimple(value, metric) {
            switch(metric) {
                case 'rft': return value.toFixed(1) + '%';
                case 'ppm': return Math.floor(value) + ' PPM';
                case 'scrap': return value.toFixed(1) + 'kg';
                case 'efficiency': return value.toFixed(1) + '%';
                default: return value.toString();
            }
        }

        async function updateAssessmentSimple(assessment) {
            const assessments = [
                { 
                    metric: 'Overall Status', 
                    value: assessment.overall.charAt(0).toUpperCase() + assessment.overall.slice(1), 
                    confidence: 0.98,
                    description: 'All metrics on target'
                },
                { 
                    metric: 'Risk Level', 
                    value: assessment.risk.charAt(0).toUpperCase() + assessment.risk.slice(1) + ' Risk', 
                    confidence: 0.85,
                    description: assessment.risk === 'low' ? 'No immediate action needed' : 'Monitor situation'
                },
                { 
                    metric: 'Maintenance Need', 
                    value: assessment.maintenance === 'not-required' ? 'Not Required' : 
                           assessment.maintenance === 'consider' ? 'Consider Soon' : 'Required', 
                    confidence: 0.91,
                    description: assessment.maintenance === 'not-required' ? 'Equipment running well' : 'Check equipment status'
                }
            ];

            const grid = document.getElementById('classificationGrid');
            grid.innerHTML = assessments.map(cls => {
                const confidence = Math.floor(cls.confidence * 100);
                const confidenceClass = confidence > 90 ? 'high' : confidence > 75 ? 'medium' : 'low';
                const confidenceLabel = confidence > 90 ? 'Confirmed' : confidence > 75 ? 'Likely' : 'Possible';
                const valueColor = cls.value.includes('Excellent') || cls.value.includes('Low Risk') || cls.value.includes('Not Required') ? 
                                  '#059669' : cls.value.includes('Good') ? '#10b981' : '#d97706';
                
                return `
                    <div class="prediction-item ${confidenceClass}-confidence fade-in">
                        <div class="prediction-header">
                            <span class="prediction-metric">${cls.metric}</span>
                            <span class="confidence-badge confidence-${confidenceClass}">
                                ${confidenceLabel}
                            </span>
                        </div>
                        <div class="prediction-value" style="font-size: 1.2rem; color: ${valueColor};">${cls.value}</div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                            ${cls.description}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateRecommendationsSimple(recommendations) {
            const list = document.getElementById('recommendationsList');
            
            if (recommendations.length === 0) {
                list.innerHTML = `
                    <div class="recommendation-item priority-low">
                        <div class="recommendation-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="recommendation-content">
                            <div class="recommendation-title">No Actions Required</div>
                            <div class="recommendation-description">All quality metrics are within acceptable ranges.</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = recommendations.map(rec => `
                <div class="recommendation-item priority-${rec.priority}">
                    <div class="recommendation-icon">
                        <i class="fas fa-${rec.icon}"></i>
                    </div>
                    <div class="recommendation-content">
                        <div class="recommendation-title">${rec.title}</div>
                        <div class="recommendation-description">${rec.description}</div>
                    </div>
                </div>
            `).join('');
        }

        function updateTRAMValuesAdvanced() {
            // Enhanced TRAM updates with animations
            const metrics = [
                { id: 'rftValue', value: (95 + Math.random() * 4).toFixed(1), unit: '%' },
                { id: 'ppmValue', value: Math.floor(120 + Math.random() * 80), unit: 'PPM' },
                { id: 'scrapValue', value: (1.5 + Math.random() * 2).toFixed(1), unit: 'kg' },
                { id: 'efficiencyValue', value: (85 + Math.random() * 10).toFixed(1), unit: '%' }
            ];

            metrics.forEach(metric => {
                const element = document.getElementById(metric.id);
                if (element) {
                    // Add update animation
                    element.style.transform = 'scale(1.1)';
                    element.style.transition = 'transform 0.3s ease';
                    
                    setTimeout(() => {
                        element.innerHTML = `${metric.value}<span class="tram-unit">${metric.unit}</span>`;
                        element.style.transform = 'scale(1)';
                    }, 150);
                }
            });
        }

        function updateChartVisuals() {
            const chartLines = document.querySelectorAll('.chart-line');
            chartLines.forEach(line => {
                const newWidth = Math.random() * 40 + 50; // 50-90%
                line.style.setProperty('--chart-width', newWidth + '%');
                line.style.animation = 'none';
                setTimeout(() => {
                    line.style.animation = 'chartGrow 1.5s ease-out';
                }, 10);
            });
        }

        function startAdvancedAnimations() {
            // Pulse animation for AI indicators
            const pulseElements = document.querySelectorAll('.pulse');
            pulseElements.forEach(element => {
                element.style.animation = 'pulse 2s infinite';
            });

            // Hover effects for cards
            const tramCards = document.querySelectorAll('.tram-card');
            tramCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-6px) scale(1.02)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        }

        function exportResults() {
            const data = {
                timestamp: new Date().toISOString(),
                productionLine: document.getElementById('productionLine').value,
                timePeriod: document.getElementById('timePeriod').value,
                metrics: {
                    rft: document.getElementById('rftValue').textContent,
                    ppm: document.getElementById('ppmValue').textContent,
                    scrap: document.getElementById('scrapValue').textContent,
                    efficiency: document.getElementById('efficiencyValue').textContent
                },
                predictions: Array.from(document.querySelectorAll('#predictionsGrid .prediction-item')).map(item => ({
                    metric: item.querySelector('.prediction-metric').textContent,
                    value: item.querySelector('.prediction-value').textContent,
                    confidence: item.querySelector('.confidence-badge').textContent
                })),
                recommendations: Array.from(document.querySelectorAll('#recommendationsList .recommendation-item')).map(item => ({
                    title: item.querySelector('.recommendation-title').textContent,
                    description: item.querySelector('.recommendation-description').textContent
                }))
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quality-check-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Quality report saved successfully!', 'success');
        }

        function updateConfidenceThreshold(threshold) {
            // This function is no longer needed in the simplified version
            // but keeping it for compatibility
        }

        function startRealTimeUpdates() {
            // Update quality values every 30 seconds
            setInterval(() => {
                if (!qualityEngine.isRunning) {
                    updateTRAMValuesAdvanced();
                    updateChartVisuals();
                }
            }, 30000);
            
            // Update KPIs every minute
            setInterval(() => {
                const kpiValues = document.querySelectorAll('.kpi-value');
                kpiValues.forEach(value => {
                    const current = parseFloat(value.textContent);
                    const variation = (Math.random() - 0.5) * 2;
                    const newValue = Math.max(0, current + variation).toFixed(1);
                    value.textContent = newValue + '%';
                });
            }, 60000);
        }

        // Enhanced Chatbot System
        let chatState = {
            isOpen: false,
            isTyping: false,
            apiUrl: 'http://localhost:5001/api',
            currentContext: {
                currentPage: 'Quality Predictions',
                userRole: 'Technician',
                features: ['Quality-Check', 'Predictions', 'Standards']
            }
        };

        // Initialize enhanced chatbot
        function initializeChatbot() {
            const chatButton = document.getElementById('chatButton');
            const chatContainer = document.getElementById('chatContainer');
            const chatClose = document.getElementById('chatClose');
            const chatSend = document.getElementById('chatSend');
            const chatInput = document.getElementById('chatInput');

            // Toggle chat
            chatButton.addEventListener('click', toggleChat);
            chatClose.addEventListener('click', closeChat);

            // Send message
            chatSend.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Load welcome message and suggestions
            loadWelcomeMessage();
            loadSuggestions();
        }

        function toggleChat() {
            const chatButton = document.getElementById('chatButton');
            const chatContainer = document.getElementById('chatContainer');

            if (chatState.isOpen) {
                closeChat();
            } else {
                openChat();
            }
        }

        function openChat() {
            const chatButton = document.getElementById('chatButton');
            const chatContainer = document.getElementById('chatContainer');

            chatState.isOpen = true;
            chatButton.classList.add('active');
            chatContainer.classList.add('open');
            
            // Focus input after animation
            setTimeout(() => {
                document.getElementById('chatInput').focus();
            }, 300);
        }

        function closeChat() {
            const chatButton = document.getElementById('chatButton');
            const chatContainer = document.getElementById('chatContainer');

            chatState.isOpen = false;
            chatButton.classList.remove('active');
            chatContainer.classList.remove('open');
        }

        async function loadWelcomeMessage() {
            try {
                const response = await fetch(`${chatState.apiUrl}/welcome`);
                if (response.ok) {
                    const data = await response.json();
                    displayMessage(data.message, 'bot', data.isMarkdown);
                }
            } catch (error) {
                displayMessage('Welcome to LEONI Quality Assistant! I can help you understand quality standards, procedures, and what these numbers mean.', 'bot');
            }
        }

        async function loadSuggestions() {
            try {
                const response = await fetch(`${chatState.apiUrl}/suggestions`);
                if (response.ok) {
                    const data = await response.json();
                    displaySuggestions(data.suggestions);
                }
            } catch (error) {
                // Fallback suggestions for quality technicians
                const suggestions = [
                    "What does PPM mean?",
                    "How do I improve quality?",
                    "What should I do if quality drops?",
                    "Explain the trend arrows",
                    "When should I call supervisor?"
                ];
                displaySuggestions(suggestions);
            }
        }

        function displaySuggestions(suggestions) {
            const suggestionsContainer = document.getElementById('chatSuggestions');
            
            suggestionsContainer.innerHTML = suggestions.map(suggestion => 
                `<div class="chat-suggestion" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
            ).join('');
        }

        function selectSuggestion(suggestion) {
            document.getElementById('chatInput').value = suggestion;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || chatState.isTyping) return;

            // Display user message
            displayMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch(`${chatState.apiUrl}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        context: chatState.currentContext
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Simulate typing delay
                    const typingDelay = Math.min(2000, Math.max(1000, data.response.length * 20));
                    
                    setTimeout(() => {
                        hideTypingIndicator();
                        displayMessage(data.response, 'bot', data.isMarkdown);
                    }, typingDelay);
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                hideTypingIndicator();
                displayMessage(generateContextualResponse(message), 'bot');
            }
        }

        function showTypingIndicator() {
            chatState.isTyping = true;
            const messagesContainer = document.getElementById('chatMessages');
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-typing';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <span class="bot-name">AI Assistant</span>
                <div class="chat-typing-dots">
                    <div class="chat-typing-dot"></div>
                    <div class="chat-typing-dot"></div>
                    <div class="chat-typing-dot"></div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            chatState.isTyping = false;
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function displayMessage(message, sender, isMarkdown = false) {
            const messagesContainer = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            if (sender === 'bot') {
                let content = `<span class="bot-name">AI Assistant</span>`;
                
                if (isMarkdown) {
                    content += renderMarkdown(message);
                } else {
                    content += message;
                }
                
                messageDiv.innerHTML = content;
            } else {
                messageDiv.textContent = message;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function renderMarkdown(text) {
            // Enhanced markdown rendering with math support
            if (typeof marked !== 'undefined') {
                // Configure marked for better rendering
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    sanitize: false
                });
                
                let html = marked.parse(text);
                
                // Render LaTeX math expressions
                if (typeof katex !== 'undefined') {
                    // Display math ($$...$$)
                    html = html.replace(/\$\$([\s\S]*?)\$\$/g, function(match, math) {
                        try {
                            return katex.renderToString(math, { displayMode: true });
                        } catch (e) {
                            return match;
                        }
                    });
                    
                    // Inline math ($...$)
                    html = html.replace(/\$([^$\n]+?)\$/g, function(match, math) {
                        try {
                            return katex.renderToString(math, { displayMode: false });
                        } catch (e) {
                            return match;
                        }
                    });
                }
                
                return html;
            }
            
            // Fallback: basic markdown parsing
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        function generateContextualResponse(message) {
            const responses = {
                'ppm': "PPM means 'Parts Per Million' - it shows how many defective parts we might find in a million parts. Lower numbers are better. Our current 142 PPM is good (under 200 limit).",
                'quality': "Current quality shows 'First Time Right' at 96.8% - this means almost 97 out of 100 parts are perfect on the first try. This is excellent!",
                'efficiency': "Production efficiency at 89.2% means our line is running well - we're making 89 parts for every 100 we should make per hour. Above our 85% goal!",
                'prediction': "The system checks patterns to predict what might happen next. It's like weather forecast but for quality - helps us prepare ahead of time.",
                'scrap': "Waste material at 2.3kg is good - we're throwing away less than 3kg limit. The arrow shows we're doing better than before.",
                'trend': "Arrows show if things are getting better (â†—) or worse (â†˜). Green arrows mean improvement, red arrows mean we need to watch more carefully.",
                'defect': "Defects are parts that don't meet quality standards. We track them to find problems early and fix them before they get worse.",
                'rft': "'First Time Right' means parts that pass quality check on the first attempt - no rework needed. Higher percentages are better.",
                'maintenance': "Based on current data, equipment is running normally. No maintenance needed right now - all systems are healthy.",
                'supervisor': "Call your supervisor if: PPM goes above 180, quality drops below 95%, waste goes above 2.8kg, or you see red alerts.",
                'limit': "Quality limits are set by engineering to ensure customer satisfaction. Stay within green zones - yellow means caution, red means stop and check.",
                'help': "I can explain any numbers you see, help with procedures, or answer questions about quality standards. Just ask in simple words!"
            };

            const keywords = Object.keys(responses);
            const foundKeyword = keywords.find(keyword => message.toLowerCase().includes(keyword));
            
            if (foundKeyword) {
                return responses[foundKeyword];
            }
            
            return "I can help explain quality numbers, procedures, and standards. Try asking about PPM, quality trends, when to call supervisor, or what any of these numbers mean!";
        }

        // Initialize chatbot when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            initializeMetricFilters();
            startRealTimeUpdates();
            startAdvancedAnimations();
            initializeChatbot(); // Initialize the chatbot
        });

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'var(--gradient-success)',
                error: 'var(--gradient-danger)',
                info: 'var(--gradient-primary)',
                warning: 'var(--gradient-warning)'
            };

            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle',
                warning: 'fas fa-exclamation-triangle'
            };

            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: fadeInUp 0.3s ease-out;
                max-width: 300px;
            `;
            notification.innerHTML = `<i class="${icons[type]}"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Chat input enter key (remove this duplicate since it's now handled in initializeChatbot)
        // document.getElementById('chatInput').addEventListener('keypress', function(e) {
        //     if (e.key === 'Enter') {
        //         sendMessage();
        //     }
        // });

        // Add fadeOut animation and recommendation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-20px); }
            }
            
            .recommendations-list {
                display: grid;
                gap: 1rem;
            }
            
            .recommendation-item {
                display: flex;
                align-items: flex-start;
                gap: 1rem;
                padding: 1rem;
                border-radius: var(--border-radius);
                border-left: 4px solid;
                background: #f8fafc;
                transition: all 0.3s ease;
            }
            
            .recommendation-item:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }
            
            .recommendation-item.priority-low {
                border-left-color: #10b981;
                background: linear-gradient(135deg, #f0fdf4 0%, #f8fafc 100%);
            }
            
            .recommendation-item.priority-medium {
                border-left-color: #f59e0b;
                background: linear-gradient(135deg, #fffbeb 0%, #f8fafc 100%);
            }
            
            .recommendation-item.priority-high {
                border-left-color: #ef4444;
                background: linear-gradient(135deg, #fef2f2 0%, #f8fafc 100%);
            }
            
            .recommendation-icon {
                width: 2.5rem;
                height: 2.5rem;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                font-size: 1.125rem;
            }
            
            .priority-low .recommendation-icon {
                background: #10b981;
                color: white;
            }
            
            .priority-medium .recommendation-icon {
                background: #f59e0b;
                color: white;
            }
            
            .priority-high .recommendation-icon {
                background: #ef4444;
                color: white;
            }
            
            .recommendation-content {
                flex: 1;
            }
            
            .recommendation-title {
                font-weight: 600;
                color: #374151;
                margin-bottom: 0.25rem;
                font-size: 0.875rem;
            }
            
            .recommendation-description {
                color: #6b7280;
                font-size: 0.8rem;
                line-height: 1.4;
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- Enhanced Markdown & Math Support -->
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx" crossorigin="anonymous"></script>
    
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>
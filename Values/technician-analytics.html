<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Analytics - LEONI Technician Dashboard</title>
    <link rel="icon" href="../assets/logo.png?v=2025" type="image/png">
    <link rel="shortcut icon" href="../assets/logo.png?v=2025" type="image/png">
    <link rel="apple-touch-icon" href="../assets/logo.png?v=2025">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="technician-analytics.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="header">
            <div class="header-logo">
                <img src="../assets/logo.png" alt="LEONI Logo">
                <div>
                    <h2>LEONI</h2>
                    <p style="font-size: 0.8rem; color: #6b7280;">Quality Excellence</p>
                </div>
            </div>
            
            <div class="header-title">
                <h1><i class="fas fa-robot"></i> AI-Powered Analytics</h1>
                <p class="header-subtitle">Machine Learning Assistant for Technician Operations</p>
            </div>
            
            <div class="ai-status">
                <div class="pulse"></div>
                <span>AI Active</span>
            </div>
        </header>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="kpi-overview">
                <h3 style="color: #374151; margin-bottom: 1rem;">Live KPIs</h3>
                
                <div class="kpi-card">
                    <div class="kpi-header">
                        <span class="kpi-title">Overall Efficiency</span>
                        <i class="fas fa-chart-line" style="color: var(--primary-color);"></i>
                    </div>
                    <div class="kpi-value">94.2%</div>
                    <div class="kpi-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>+2.3%</span>
                    </div>
                </div>

                <div class="kpi-card" style="border-left-color: var(--success-color);">
                    <div class="kpi-header">
                        <span class="kpi-title">Quality Score</span>
                        <i class="fas fa-star" style="color: var(--success-color);"></i>
                    </div>
                    <div class="kpi-value" style="color: var(--success-color);">98.7%</div>
                    <div class="kpi-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>+0.8%</span>
                    </div>
                </div>

                <div class="kpi-card" style="border-left-color: var(--warning-color);">
                    <div class="kpi-header">
                        <span class="kpi-title">Production Rate</span>
                        <i class="fas fa-tachometer-alt" style="color: var(--warning-color);"></i>
                    </div>
                    <div class="kpi-value" style="color: var(--warning-color);">87.5%</div>
                    <div class="kpi-trend trend-down">
                        <i class="fas fa-arrow-down"></i>
                        <span>-1.2%</span>
                    </div>
                </div>
            </div>

            <div style="background: #f8fafc; border-radius: var(--border-radius); padding: 1rem;">
                <h4 style="color: #374151; margin-bottom: 0.5rem;">Quick Actions</h4>
                <div style="display: grid; gap: 0.5rem;">
                    <button class="ml-button" style="font-size: 0.875rem; padding: 0.5rem;">
                        <i class="fas fa-calculator"></i>
                        Calculate TRAM
                    </button>
                    <button class="ml-button" style="font-size: 0.875rem; padding: 0.5rem;">
                        <i class="fas fa-chart-bar"></i>
                        Generate Report
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- ML Controls -->
            <section class="ml-controls">
                <div class="ml-controls-title">
                    <i class="fas fa-brain"></i>
                    Machine Learning Configuration
                </div>
                
                <div class="ml-controls-grid">
                    <div class="control-group">
                        <label class="control-label">Production Line</label>
                        <select class="control-select" id="productionLine">
                            <option value="hdep-c1">HDEP C1</option>
                            <option value="hdep-c2">HDEP C2</option>
                            <option value="vce">VCE Line</option>
                            <option value="mdep">MDEP</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Time Period</label>
                        <select class="control-select" id="timePeriod">
                            <option value="1h">Last Hour</option>
                            <option value="8h">Last 8 Hours</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label class="control-label">Confidence Level</label>
                        <input type="range" class="control-input" id="confidence" min="70" max="99" value="85">
                        <span id="confidenceValue" style="font-size: 0.875rem; color: #6b7280;">85%</span>
                    </div>
                </div>

                <div class="ml-actions">
                    <button class="ml-button" onclick="runMLAnalysis()">
                        <i class="fas fa-play"></i>
                        Run Analysis
                    </button>
                    <button class="ml-button" onclick="exportResults()" style="background: var(--gradient-success);">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                </div>

                <div class="ml-algorithm-selector">
                    <button class="algorithm-btn active" data-algorithm="neural">Neural Network</button>
                    <button class="algorithm-btn" data-algorithm="forest">Random Forest</button>
                    <button class="algorithm-btn" data-algorithm="svm">SVM</button>
                </div>
            </section>

            <!-- TRAM Metrics Container -->
            <section class="tram-metrics-container">
                <div class="metrics-header">
                    <h2 class="metrics-title">TRAM Analytics Dashboard</h2>
                    <div class="metrics-controls">
                        <button class="metric-filter active" data-filter="all">All Metrics</button>
                        <button class="metric-filter" data-filter="quality">Quality</button>
                        <button class="metric-filter" data-filter="efficiency">Efficiency</button>
                    </div>
                    <div class="ml-status-indicator">
                        <div class="pulse"></div>
                        <span>ML Active</span>
                    </div>
                </div>

                <!-- Enhanced TRAM Analytics -->
                <section class="tram-analytics">
                    <div class="tram-card rft">
                        <div class="tram-header">
                            <div>
                                <div class="tram-value" id="rftValue">
                                    96.8<span class="tram-unit">%</span>
                                </div>
                                <div class="tram-label">Right First Time</div>
                            </div>
                            <div class="tram-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                        <div class="tram-chart">
                            <div class="chart-line" style="--chart-width: 87%; background: var(--success-color);"></div>
                        </div>
                        <div class="tram-details">
                            <div class="detail-item">
                                <span>Target:</span>
                                <span class="detail-value">95.0%</span>
                            </div>
                            <div class="detail-item">
                                <span>Trend:</span>
                                <span class="detail-value" style="color: var(--success-color);">â†— +1.8%</span>
                            </div>
                        </div>
                    </div>

                    <div class="tram-card ppm">
                        <div class="tram-header">
                            <div>
                                <div class="tram-value" id="ppmValue">
                                    142<span class="tram-unit">PPM</span>
                                </div>
                                <div class="tram-label">Parts Per Million</div>
                            </div>
                            <div class="tram-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="tram-chart">
                            <div class="chart-line" style="--chart-width: 65%; background: var(--warning-color);"></div>
                        </div>
                        <div class="tram-details">
                            <div class="detail-item">
                                <span>Target:</span>
                                <span class="detail-value">< 200</span>
                            </div>
                            <div class="detail-item">
                                <span>Trend:</span>
                                <span class="detail-value" style="color: var(--success-color);">â†˜ -12</span>
                            </div>
                        </div>
                    </div>

                    <div class="tram-card scrap">
                        <div class="tram-header">
                            <div>
                                <div class="tram-value" id="scrapValue">
                                    2.3<span class="tram-unit">kg</span>
                                </div>
                                <div class="tram-label">Scrap Weight</div>
                            </div>
                            <div class="tram-icon">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                        <div class="tram-chart">
                            <div class="chart-line" style="--chart-width: 45%; background: var(--danger-color);"></div>
                        </div>
                        <div class="tram-details">
                            <div class="detail-item">
                                <span>Target:</span>
                                <span class="detail-value">< 3.0kg</span>
                            </div>
                            <div class="detail-item">
                                <span>Trend:</span>
                                <span class="detail-value" style="color: var(--success-color);">â†˜ -0.7kg</span>
                            </div>
                        </div>
                    </div>

                    <div class="tram-card efficiency">
                        <div class="tram-header">
                            <div>
                                <div class="tram-value" id="efficiencyValue">
                                    89.2<span class="tram-unit">%</span>
                                </div>
                                <div class="tram-label">Line Efficiency</div>
                            </div>
                            <div class="tram-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                        </div>
                        <div class="tram-chart">
                            <div class="chart-line" style="--chart-width: 78%; background: var(--info-color);"></div>
                        </div>
                        <div class="tram-details">
                            <div class="detail-item">
                                <span>Target:</span>
                                <span class="detail-value">85.0%</span>
                            </div>
                            <div class="detail-item">
                                <span>Trend:</span>
                                <span class="detail-value" style="color: var(--success-color);">â†— +4.2%</span>
                            </div>
                        </div>
                    </div>
                </section>
            </section>

            <!-- ML Results -->
            <section class="ml-results">
                <div class="results-section predictions">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-crystal-ball"></i>
                        </div>
                        <h3 class="section-title">Predictions</h3>
                    </div>
                    
                    <div class="prediction-grid" id="predictionsGrid">
                        <div class="prediction-item high-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">RFT Next Hour</span>
                                <span class="confidence-badge confidence-high">95% Confidence</span>
                            </div>
                            <div class="prediction-value">97.2%</div>
                        </div>

                        <div class="prediction-item medium-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">PPM Forecast</span>
                                <span class="confidence-badge confidence-medium">82% Confidence</span>
                            </div>
                            <div class="prediction-value">156 PPM</div>
                        </div>

                        <div class="prediction-item high-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">Scrap Prediction</span>
                                <span class="confidence-badge confidence-high">91% Confidence</span>
                            </div>
                            <div class="prediction-value">1.8kg</div>
                        </div>
                    </div>
                </div>

                <div class="results-section classification">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-tags"></i>
                        </div>
                        <h3 class="section-title">Classification</h3>
                    </div>
                    
                    <div class="prediction-grid" id="classificationGrid">
                        <div class="prediction-item high-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">Quality Status</span>
                                <span class="confidence-badge confidence-high">98% Confidence</span>
                            </div>
                            <div class="prediction-value" style="font-size: 1.2rem;">Excellent</div>
                        </div>

                        <div class="prediction-item medium-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">Risk Level</span>
                                <span class="confidence-badge confidence-medium">76% Confidence</span>
                            </div>
                            <div class="prediction-value" style="font-size: 1.2rem;">Low Risk</div>
                        </div>

                        <div class="prediction-item high-confidence">
                            <div class="prediction-header">
                                <span class="prediction-metric">Maintenance</span>
                                <span class="confidence-badge confidence-high">89% Confidence</span>
                            </div>
                            <div class="prediction-value" style="font-size: 1.2rem;">Not Required</div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-nav">
                <a href="../Agents_onBoarding/technician-onboarding.html" class="footer-link">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <a href="../index.html" class="footer-link">
                    <i class="fas fa-home"></i> Main Menu
                </a>
            </div>
            
            <div style="color: #6b7280; font-size: 0.875rem;">
                <i class="fas fa-robot"></i> AI Engine v2.1 | Last Updated: June 2025
            </div>
        </footer>
    </div>

    <!-- Chatbot Interface -->
    <button class="chat-button" id="chatButton">
        ðŸ’¬
    </button>

    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <h3><i class="fas fa-robot"></i> LEONI AI Assistant</h3>
            <p>AI-powered analytics and quality insights</p>
            <button class="chat-close" id="chatClose">Ã—</button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div style="color: #6b7280; font-style: italic; text-align: center; padding: 2rem;">
                Ask me about quality metrics, ML predictions, TRAM analytics, or optimization suggestions...
            </div>
        </div>
        
        <div class="chat-suggestions" id="chatSuggestions">
            <!-- Suggestions will be loaded here -->
        </div>
        
        <div class="chat-input-container">
            <div class="chat-input-group">
                <input type="text" class="chat-input" placeholder="Ask about analytics, predictions, quality metrics..." id="chatInput">
                <button class="chat-send" id="chatSend">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <div class="chat-resize-handle" id="chatResizeHandle"></div>
    </div>

    <script>
        // Enhanced ML Analytics Engine
        class MLAnalyticsEngine {
            constructor() {
                this.algorithms = {
                    neural: { name: 'Neural Network', accuracy: 0.94 },
                    forest: { name: 'Random Forest', accuracy: 0.89 },
                    svm: { name: 'Support Vector Machine', accuracy: 0.91 }
                };
                this.currentAlgorithm = 'neural';
                this.isRunning = false;
                this.historicalData = this.generateHistoricalData();
            }

            generateHistoricalData() {
                const data = [];
                for (let i = 0; i < 100; i++) {
                    data.push({
                        timestamp: new Date(Date.now() - i * 3600000),
                        rft: 95 + Math.random() * 4,
                        ppm: 120 + Math.random() * 80,
                        scrap: 1.5 + Math.random() * 2,
                        efficiency: 85 + Math.random() * 10
                    });
                }
                return data;
            }

            async runPrediction(metric, timeframe) {
                const algorithm = this.algorithms[this.currentAlgorithm];
                const baseAccuracy = algorithm.accuracy;
                
                // Simulate ML processing
                await this.simulateProcessing(2000);
                
                const recent = this.historicalData.slice(0, timeframe);
                const average = recent.reduce((sum, item) => sum + item[metric], 0) / recent.length;
                
                const prediction = {
                    value: this.generatePrediction(average, metric),
                    confidence: baseAccuracy + (Math.random() * 0.1 - 0.05),
                    algorithm: algorithm.name,
                    factors: this.generateFactors(metric)
                };

                return prediction;
            }

            generatePrediction(average, metric) {
                const variation = (Math.random() - 0.5) * 0.1;
                const trend = Math.sin(Date.now() / 1000000) * 0.05;
                
                switch(metric) {
                    case 'rft':
                        return Math.max(90, Math.min(99, average + variation + trend));
                    case 'ppm':
                        return Math.max(50, Math.min(300, average + variation * 50));
                    case 'scrap':
                        return Math.max(0.5, Math.min(5, average + variation * 2));
                    case 'efficiency':
                        return Math.max(75, Math.min(95, average + variation * 10));
                    default:
                        return average;
                }
            }

            generateFactors(metric) {
                const factors = {
                    rft: ['Process Stability', 'Operator Skill', 'Material Quality', 'Equipment Condition'],
                    ppm: ['Quality Control', 'Inspection Rate', 'Process Variation', 'Supplier Quality'],
                    scrap: ['Material Waste', 'Rework Rate', 'Process Efficiency', 'Quality Issues'],
                    efficiency: ['Downtime', 'Cycle Time', 'Operator Performance', 'Equipment OEE']
                };
                return factors[metric] || [];
            }

            async simulateProcessing(duration) {
                return new Promise(resolve => setTimeout(resolve, duration));
            }
        }

        // Initialize ML Engine
        const mlEngine = new MLAnalyticsEngine();

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            initializeAlgorithmButtons();
            initializeMetricFilters();
            startRealTimeUpdates();
            startAdvancedAnimations();
        });

        function initializeDashboard() {
            // Add fade-in animation to cards
            const cards = document.querySelectorAll('.tram-card, .prediction-item, .insight-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in');
                }, index * 100);
            });

            // Initialize confidence slider
            const confidenceSlider = document.getElementById('confidence');
            const confidenceValue = document.getElementById('confidenceValue');
            
            confidenceSlider.addEventListener('input', function() {
                confidenceValue.textContent = this.value + '%';
                updateConfidenceThreshold(this.value);
            });
        }

        function initializeAlgorithmButtons() {
            const algorithmBtns = document.querySelectorAll('.algorithm-btn');
            algorithmBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    algorithmBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    mlEngine.currentAlgorithm = this.dataset.algorithm;
                    showNotification(`Switched to ${mlEngine.algorithms[this.dataset.algorithm].name}`, 'info');
                });
            });
        }

        function initializeMetricFilters() {
            const filterBtns = document.querySelectorAll('.metric-filter');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    filterMetrics(this.dataset.filter);
                });
            });
        }

        function filterMetrics(filter) {
            const cards = document.querySelectorAll('.tram-card');
            cards.forEach(card => {
                if (filter === 'all') {
                    card.style.display = 'grid';
                } else if (filter === 'quality') {
                    card.style.display = card.classList.contains('rft') || card.classList.contains('ppm') ? 'grid' : 'none';
                } else if (filter === 'efficiency') {
                    card.style.display = card.classList.contains('efficiency') || card.classList.contains('scrap') ? 'grid' : 'none';
                }
            });
        }

        async function runMLAnalysis() {
            if (mlEngine.isRunning) return;
            
            mlEngine.isRunning = true;
            const button = document.querySelector('.ml-button');
            const originalText = button.innerHTML;
            
            // Show loading state
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            button.disabled = true;
            
            // Add loading animation to results
            const resultsSections = document.querySelectorAll('.results-section');
            resultsSections.forEach(section => section.classList.add('loading'));
            
            try {
                // Run ML predictions for each metric
                const predictions = await Promise.all([
                    mlEngine.runPrediction('rft', 24),
                    mlEngine.runPrediction('ppm', 24),
                    mlEngine.runPrediction('scrap', 24),
                    mlEngine.runPrediction('efficiency', 24)
                ]);

                // Update UI with predictions
                await updatePredictionsAdvanced(predictions);
                await updateClassificationsAdvanced();
                await updateTRAMValuesAdvanced();
                
                // Update chart animations
                updateChartVisuals();
                
                showNotification('Advanced ML analysis completed successfully!', 'success');
            } catch (error) {
                showNotification('Analysis failed: ' + error.message, 'error');
            } finally {
                // Remove loading state
                resultsSections.forEach(section => section.classList.remove('loading'));
                button.innerHTML = originalText;
                button.disabled = false;
                mlEngine.isRunning = false;
            }
        }

        async function updatePredictionsAdvanced(predictions) {
            const metrics = ['RFT Next Hour', 'PPM Forecast', 'Scrap Prediction', 'Efficiency Forecast'];
            const grid = document.getElementById('predictionsGrid');
            
            grid.innerHTML = predictions.map((pred, index) => {
                const confidence = Math.floor(pred.confidence * 100);
                const confidenceClass = confidence > 90 ? 'high' : confidence > 75 ? 'medium' : 'low';
                
                return `
                    <div class="prediction-item ${confidenceClass}-confidence fade-in">
                        <div class="prediction-header">
                            <span class="prediction-metric">${metrics[index]}</span>
                            <span class="confidence-badge confidence-${confidenceClass}">
                                ${confidence}% Confidence
                            </span>
                        </div>
                        <div class="prediction-value">${formatPredictionValue(pred.value, index)}</div>
                        <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                            Algorithm: ${pred.algorithm}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatPredictionValue(value, index) {
            switch(index) {
                case 0: return value.toFixed(1) + '%';
                case 1: return Math.floor(value) + ' PPM';
                case 2: return value.toFixed(1) + 'kg';
                case 3: return value.toFixed(1) + '%';
                default: return value.toString();
            }
        }

        async function updateClassificationsAdvanced() {
            const classifications = [
                { metric: 'Quality Status', value: 'Excellent', confidence: 0.98 },
                { metric: 'Risk Level', value: 'Low Risk', confidence: 0.85 },
                { metric: 'Maintenance', value: 'Optimal', confidence: 0.91 },
                { metric: 'Performance', value: 'Above Target', confidence: 0.94 }
            ];

            const grid = document.getElementById('classificationGrid');
            grid.innerHTML = classifications.map(cls => {
                const confidence = Math.floor(cls.confidence * 100);
                const confidenceClass = confidence > 90 ? 'high' : confidence > 75 ? 'medium' : 'low';
                
                return `
                    <div class="prediction-item ${confidenceClass}-confidence fade-in">
                        <div class="prediction-header">
                            <span class="prediction-metric">${cls.metric}</span>
                            <span class="confidence-badge confidence-${confidenceClass}">
                                ${confidence}% Confidence
                            </span>
                        </div>
                        <div class="prediction-value" style="font-size: 1.2rem;">${cls.value}</div>
                    </div>
                `;
            }).join('');
        }

        function updateTRAMValuesAdvanced() {
            // Enhanced TRAM updates with animations
            const metrics = [
                { id: 'rftValue', value: (95 + Math.random() * 4).toFixed(1), unit: '%' },
                { id: 'ppmValue', value: Math.floor(120 + Math.random() * 80), unit: 'PPM' },
                { id: 'scrapValue', value: (1.5 + Math.random() * 2).toFixed(1), unit: 'kg' },
                { id: 'efficiencyValue', value: (85 + Math.random() * 10).toFixed(1), unit: '%' }
            ];

            metrics.forEach(metric => {
                const element = document.getElementById(metric.id);
                if (element) {
                    // Add update animation
                    element.style.transform = 'scale(1.1)';
                    element.style.transition = 'transform 0.3s ease';
                    
                    setTimeout(() => {
                        element.innerHTML = `${metric.value}<span class="tram-unit">${metric.unit}</span>`;
                        element.style.transform = 'scale(1)';
                    }, 150);
                }
            });
        }

        function updateChartVisuals() {
            const chartLines = document.querySelectorAll('.chart-line');
            chartLines.forEach(line => {
                const newWidth = Math.random() * 40 + 50; // 50-90%
                line.style.setProperty('--chart-width', newWidth + '%');
                line.style.animation = 'none';
                setTimeout(() => {
                    line.style.animation = 'chartGrow 1.5s ease-out';
                }, 10);
            });
        }

        function startAdvancedAnimations() {
            // Pulse animation for AI indicators
            const pulseElements = document.querySelectorAll('.pulse');
            pulseElements.forEach(element => {
                element.style.animation = 'pulse 2s infinite';
            });

            // Hover effects for cards
            const tramCards = document.querySelectorAll('.tram-card');
            tramCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-6px) scale(1.02)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });
        }

        function exportResults() {
            const data = {
                timestamp: new Date().toISOString(),
                algorithm: mlEngine.currentAlgorithm,
                metrics: {
                    rft: document.getElementById('rftValue').textContent,
                    ppm: document.getElementById('ppmValue').textContent,
                    scrap: document.getElementById('scrapValue').textContent,
                    efficiency: document.getElementById('efficiencyValue').textContent
                },
                predictions: Array.from(document.querySelectorAll('#predictionsGrid .prediction-item')).map(item => ({
                    metric: item.querySelector('.prediction-metric').textContent,
                    value: item.querySelector('.prediction-value').textContent,
                    confidence: item.querySelector('.confidence-badge').textContent
                }))
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ml-analysis-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Analysis results exported successfully!', 'success');
        }

        function updateConfidenceThreshold(threshold) {
            const predictionItems = document.querySelectorAll('.prediction-item');
            predictionItems.forEach(item => {
                const confidenceBadge = item.querySelector('.confidence-badge');
                const confidence = parseInt(confidenceBadge.textContent);
                
                if (confidence < threshold) {
                    item.style.opacity = '0.5';
                    item.style.filter = 'grayscale(50%)';
                } else {
                    item.style.opacity = '1';
                    item.style.filter = 'grayscale(0%)';
                }
            });
        }

        function startRealTimeUpdates() {
            // Update TRAM values every 30 seconds
            setInterval(() => {
                if (!mlEngine.isRunning) {
                    updateTRAMValuesAdvanced();
                    updateChartVisuals();
                }
            }, 30000);
            
            // Update KPIs every minute
            setInterval(() => {
                const kpiValues = document.querySelectorAll('.kpi-value');
                kpiValues.forEach(value => {
                    const current = parseFloat(value.textContent);
                    const variation = (Math.random() - 0.5) * 2;
                    const newValue = Math.max(0, current + variation).toFixed(1);
                    value.textContent = newValue + '%';
                });
            }, 60000);
        }

        // Enhanced Chatbot System
        let chatState = {
            isOpen: false,
            isTyping: false,
            apiUrl: 'http://localhost:5001/api',
            currentContext: {
                currentPage: 'Technician Analytics',
                userRole: 'Technician',
                features: ['AI-Analytics', 'TRAM-Metrics', 'ML-Predictions']
            }
        };

        // Initialize enhanced chatbot
        function initializeChatbot() {
            const chatButton = document.getElementById('chatButton');
            const chatContainer = document.getElementById('chatContainer');
            const chatClose = document.getElementById('chatClose');
            const chatSend = document.getElementById('chatSend');
            const chatInput = document.getElementById('chatInput');

            // Toggle chat
            chatButton.addEventListener('click', toggleChat);
            chatClose.addEventListener('click', closeChat);

            // Send message
            chatSend.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Load welcome message and suggestions
            loadWelcomeMessage();
            loadSuggestions();
        }

        function toggleChat() {
            const chatButton = document.getElementById('chatButton');
            const chatContainer = document.getElementById('chatContainer');

            if (chatState.isOpen) {
                closeChat();
            } else {
                openChat();
            }
        }

        function openChat() {
            const chatButton = document.getElementById('chatButton');
            const chatContainer = document.getElementById('chatContainer');

            chatState.isOpen = true;
            chatButton.classList.add('active');
            chatContainer.classList.add('open');
            
            // Focus input after animation
            setTimeout(() => {
                document.getElementById('chatInput').focus();
            }, 300);
        }

        function closeChat() {
            const chatButton = document.getElementById('chatButton');
            const chatContainer = document.getElementById('chatContainer');

            chatState.isOpen = false;
            chatButton.classList.remove('active');
            chatContainer.classList.remove('open');
        }

        async function loadWelcomeMessage() {
            try {
                const response = await fetch(`${chatState.apiUrl}/welcome`);
                if (response.ok) {
                    const data = await response.json();
                    displayMessage(data.message, 'bot', data.isMarkdown);
                }
            } catch (error) {
                displayMessage('Welcome to LEONI AI Analytics Assistant! I can help you with quality metrics, ML predictions, and TRAM analytics.', 'bot');
            }
        }

        async function loadSuggestions() {
            try {
                const response = await fetch(`${chatState.apiUrl}/suggestions`);
                if (response.ok) {
                    const data = await response.json();
                    displaySuggestions(data.suggestions);
                }
            } catch (error) {
                // Fallback suggestions for analytics
                const suggestions = [
                    "How do I interpret ML predictions?",
                    "What do the TRAM metrics mean?",
                    "Calculate process capability",
                    "Explain quality trends",
                    "Show efficiency improvements"
                ];
                displaySuggestions(suggestions);
            }
        }

        function displaySuggestions(suggestions) {
            const suggestionsContainer = document.getElementById('chatSuggestions');
            
            suggestionsContainer.innerHTML = suggestions.map(suggestion => 
                `<div class="chat-suggestion" onclick="selectSuggestion('${suggestion}')">${suggestion}</div>`
            ).join('');
        }

        function selectSuggestion(suggestion) {
            document.getElementById('chatInput').value = suggestion;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message || chatState.isTyping) return;

            // Display user message
            displayMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch(`${chatState.apiUrl}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        context: chatState.currentContext
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Simulate typing delay
                    const typingDelay = Math.min(2000, Math.max(1000, data.response.length * 20));
                    
                    setTimeout(() => {
                        hideTypingIndicator();
                        displayMessage(data.response, 'bot', data.isMarkdown);
                    }, typingDelay);
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                hideTypingIndicator();
                displayMessage(generateContextualResponse(message), 'bot');
            }
        }

        function showTypingIndicator() {
            chatState.isTyping = true;
            const messagesContainer = document.getElementById('chatMessages');
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-typing';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <span class="bot-name">AI Assistant</span>
                <div class="chat-typing-dots">
                    <div class="chat-typing-dot"></div>
                    <div class="chat-typing-dot"></div>
                    <div class="chat-typing-dot"></div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            chatState.isTyping = false;
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function displayMessage(message, sender, isMarkdown = false) {
            const messagesContainer = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            if (sender === 'bot') {
                let content = `<span class="bot-name">AI Assistant</span>`;
                
                if (isMarkdown) {
                    content += renderMarkdown(message);
                } else {
                    content += message;
                }
                
                messageDiv.innerHTML = content;
            } else {
                messageDiv.textContent = message;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function renderMarkdown(text) {
            // Enhanced markdown rendering with math support
            if (typeof marked !== 'undefined') {
                // Configure marked for better rendering
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    sanitize: false
                });
                
                let html = marked.parse(text);
                
                // Render LaTeX math expressions
                if (typeof katex !== 'undefined') {
                    // Display math ($$...$$)
                    html = html.replace(/\$\$([\s\S]*?)\$\$/g, function(match, math) {
                        try {
                            return katex.renderToString(math, { displayMode: true });
                        } catch (e) {
                            return match;
                        }
                    });
                    
                    // Inline math ($...$)
                    html = html.replace(/\$([^$\n]+?)\$/g, function(match, math) {
                        try {
                            return katex.renderToString(math, { displayMode: false });
                        } catch (e) {
                            return match;
                        }
                    });
                }
                
                return html;
            }
            
            // Fallback: basic markdown parsing
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        function generateContextualResponse(message) {
            const responses = {
                'quality': "Current quality metrics show excellent performance with RFT at 96.8%. The neural network predicts continued stability with 95% confidence.",
                'efficiency': "Line efficiency is at 89.2%, which is 4.2% above target. Consider applying these best practices to other production lines.",
                'prediction': "ML predictions indicate a 2% improvement in RFT over the next hour with 95% confidence. The Random Forest model suggests optimal conditions.",
                'scrap': "Scrap levels are well below target at 2.3kg. This suggests effective waste management practices. Continue current protocols.",
                'ppm': "Current PPM at 142 is within acceptable range. Monitor for any upward trends and implement preventive measures if needed.",
                'maintenance': "Predictive maintenance indicates optimal equipment condition. No immediate action required based on current sensor data.",
                'tram': "TRAM metrics show: RFT 96.8% (â†— +1.8%), PPM 142 (â†˜ -12), Scrap 2.3kg (â†˜ -0.7kg), Efficiency 89.2% (â†— +4.2%)",
                'algorithm': `Currently using ${mlEngine.algorithms[mlEngine.currentAlgorithm].name} with ${(mlEngine.algorithms[mlEngine.currentAlgorithm].accuracy * 100).toFixed(1)}% accuracy for predictions.`,
                'ml': "Machine Learning analysis shows high confidence predictions across all metrics. Neural network performance is optimal for current data patterns."
            };

            const keywords = Object.keys(responses);
            const foundKeyword = keywords.find(keyword => message.toLowerCase().includes(keyword));
            
            if (foundKeyword) {
                return responses[foundKeyword];
            }
            
            return "I'm analyzing your request using advanced ML algorithms. I can help with quality metrics, TRAM analytics, predictions, and optimization suggestions. What specific aspect would you like to explore?";
        }

        // Initialize chatbot when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            initializeAlgorithmButtons();
            initializeMetricFilters();
            startRealTimeUpdates();
            startAdvancedAnimations();
            initializeChatbot(); // Initialize the chatbot
        });

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'var(--gradient-success)',
                error: 'var(--gradient-danger)',
                info: 'var(--gradient-primary)',
                warning: 'var(--gradient-warning)'
            };

            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle',
                warning: 'fas fa-exclamation-triangle'
            };

            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: fadeInUp 0.3s ease-out;
                max-width: 300px;
            `;
            notification.innerHTML = `<i class="${icons[type]}"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Chat input enter key (remove this duplicate since it's now handled in initializeChatbot)
        // document.getElementById('chatInput').addEventListener('keypress', function(e) {
        //     if (e.key === 'Enter') {
        //         sendMessage();
        //     }
        // });

        // Add fadeOut animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeOut {
                from { opacity: 1; transform: translateY(0); }
                to { opacity: 0; transform: translateY(-20px); }
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- Enhanced Markdown & Math Support -->
    <!-- KaTeX for LaTeX math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" integrity="sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx" crossorigin="anonymous"></script>
    
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>